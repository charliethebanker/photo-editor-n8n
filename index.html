<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="O fotografo - Editor de fotografias automático via webhook n8n">
    <meta name="author" content="charliethebanker">
    <title>O fotografo</title>
    
    <style>
        /* ==================== RESET E VARIÁVEIS ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #252525;
            --bg-quaternary: #2f2f2f;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --text-tertiary: #808080;
            --accent-color: #6366f1;
            --accent-hover: #4f46e5;
            --accent-light: #818cf8;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --border-color: #333333;
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
            
            /* Glass effect variables */
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-hover-bg: rgba(255, 255, 255, 0.1);
            --glass-selected-bg: rgba(16, 185, 129, 0.2);
            --glass-selected-border: #10b981;
        }

        /* ==================== BASE ==================== */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* ==================== LAYOUT PRINCIPAL ==================== */
        #app {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ==================== HEADER ==================== */
        header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
        }

        header h1 {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -1px;
        }

        header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* ==================== SECÇÕES ==================== */
        section {
            display: none !important;
        }

        section.active {
            display: flex !important;
            animation: fadeIn 0.4s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ==================== UPLOAD SECTION ==================== */
        #upload-section {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        #drop-zone {
            width: 100%;
            max-width: 600px;
            min-height: 400px;
            border: 3px dashed var(--border-color);
            border-radius: var(--border-radius);
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            padding: 3rem 2rem;
            text-align: center;
        }

        #drop-zone:hover {
            border-color: var(--accent-color);
            background: var(--bg-tertiary);
            transform: scale(1.02);
        }

        #drop-zone.drag-over {
            border-color: var(--accent-light);
            background: var(--bg-quaternary);
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.3);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            opacity: 0.6;
        }

        #drop-zone h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        #drop-zone p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .btn {
            padding: 0.875rem 2rem;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-quaternary);
            border-color: var(--text-secondary);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        input[type="file"] {
            display: none;
        }

        /* ==================== PREVIEW SECTION ==================== */
        #preview-section {
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            flex: 1;
        }

        .preview-container {
            width: 100%;
            max-width: 800px;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow-md);
        }

        .preview-container h2 {
            margin-bottom: 1.5rem;
            text-align: center;
            color: var(--text-primary);
        }

        .image-preview {
            width: 100%;
            border-radius: var(--border-radius-sm);
            overflow: hidden;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 500px;
            width: auto;
            height: auto;
            display: block;
        }

        .actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* ==================== LOADING SECTION ==================== */
        #loading-section {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            gap: 2rem;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--bg-tertiary);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #loading-section p {
            font-size: 1.25rem;
            color: var(--text-secondary);
        }

        /* ==================== RESULT SECTION ==================== */
        #result-section {
            flex-direction: column;
            gap: 2rem;
            flex: 1;
        }

        .comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .image-box {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
        }

        .image-box:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .image-box h3 {
            margin-bottom: 1rem;
            text-align: center;
            color: var(--accent-light);
            font-size: 1.25rem;
        }

        .image-box .image-wrapper {
            width: 100%;
            border-radius: var(--border-radius-sm);
            overflow: hidden;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
        }

        .image-box img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        /* ==================== LIQUID GLASS FORMAT PANEL ==================== */
        .format-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .format-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .format-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .format-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .format-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        /* Liquid Glass Button */
        .liquid-button {
            position: relative;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-sm);
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-primary);
            box-shadow: 0 0 6px rgba(0, 0, 0, 0.03),
                        0 2px 6px rgba(0, 0, 0, 0.08),
                        inset 3px 3px 0.5px -3px rgba(255, 255, 255, 0.09),
                        inset -3px -3px 0.5px -3.5px rgba(255, 255, 255, 0.85),
                        inset 1px 1px 1px -0.5px rgba(255, 255, 255, 0.6),
                        inset -1px -1px 1px -0.5px rgba(255, 255, 255, 0.6),
                        inset 0 0 6px 6px rgba(255, 255, 255, 0.12),
                        inset 0 0 2px 2px rgba(255, 255, 255, 0.06),
                        0 0 12px rgba(0, 0, 0, 0.15);
        }

        .liquid-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                rgba(255, 255, 255, 0.05) 50%, 
                rgba(255, 255, 255, 0) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .liquid-button:hover {
            background: var(--glass-hover-bg);
            border-color: rgba(16, 185, 129, 0.5);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.2);
        }

        .liquid-button:hover::before {
            opacity: 1;
        }

        .liquid-button.selected {
            background: var(--glass-selected-bg);
            border: 2px solid var(--glass-selected-border);
            transform: scale(1.02);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15),
                        0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .liquid-button.selected::after {
            content: '✓';
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--success-color);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        }

        .liquid-button.loading {
            pointer-events: none;
            opacity: 0.6;
        }

        .format-icon {
            font-size: 2rem;
            margin-bottom: 0.25rem;
        }

        .format-info {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }

        .format-platform {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .format-type {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .format-ratio {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .format-dimensions {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .format-feedback {
            min-height: 30px;
            text-align: center;
            color: var(--success-color);
            font-size: 0.9rem;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease;
            margin-top: 0.5rem;
        }

        .format-feedback.show {
            opacity: 1;
        }

        .download-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* ==================== ERROR SECTION ==================== */
        #error-section {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            gap: 2rem;
            text-align: center;
        }

        .error-box {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--error-color);
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 600px;
        }

        .error-icon {
            font-size: 4rem;
            color: var(--error-color);
            margin-bottom: 1rem;
        }

        #error-text {
            color: var(--text-primary);
            font-size: 1.125rem;
            margin-bottom: 1.5rem;
        }

        /* ==================== UTILITIES ==================== */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        /* ==================== RESPONSIVO ==================== */
        @media (max-width: 768px) {
            #app {
                padding: 1rem;
            }

            header h1 {
                font-size: 2rem;
            }

            header p {
                font-size: 1rem;
            }

            #drop-zone {
                min-height: 300px;
                padding: 2rem 1rem;
            }

            .upload-icon {
                font-size: 3rem;
            }

            .comparison {
                grid-template-columns: 1fr;
            }

            .format-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }

            .liquid-button {
                padding: 1rem;
                min-height: 90px;
                font-size: 0.85rem;
            }

            .format-icon {
                font-size: 1.75rem;
            }

            .format-dimensions {
                display: none;
            }

            .actions,
            .download-actions {
                flex-direction: column;
                width: 100%;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            header h1 {
                font-size: 1.75rem;
            }

            #drop-zone h2 {
                font-size: 1.25rem;
            }

            .format-grid {
                grid-template-columns: 1fr;
            }

            .liquid-button {
                min-height: 80px;
            }

            .format-panel {
                padding: 1.5rem;
            }
        }

        /* Redução de movimento para acessibilidade */
        @media (prefers-reduced-motion: reduce) {
            .liquid-button,
            .btn {
                transition: none;
            }
            
            .liquid-button:hover {
                transform: none;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- HEADER -->
        <header>
            <h1>O fotografo</h1>
            <p>Editor de fotografias automático</p>
        </header>

        <!-- SECÇÃO 1: UPLOAD -->
        <section id="upload-section" class="active">
            <div id="drop-zone">
                <div class="upload-icon">📸</div>
                <h2>Arraste a sua foto aqui</h2>
                <p>ou clique para selecionar um ficheiro</p>
                <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                    Escolher Ficheiro
                </button>
                <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-tertiary);">
                    Máximo 10MB • JPG, PNG ou WEBP
                </p>
            </div>
            <input type="file" id="file-input" accept="image/jpeg,image/png,image/webp">
        </section>

        <!-- SECÇÃO 2: PREVIEW -->
        <section id="preview-section">
            <div class="preview-container">
                <h2>Preview da Imagem</h2>
                <div class="image-preview">
                    <img id="preview-original" alt="Preview da imagem original">
                </div>
            </div>
            <div class="actions">
                <button class="btn btn-secondary" id="btn-cancel">Cancelar</button>
                <button class="btn btn-primary" id="btn-send">Enviar para Edição</button>
            </div>
        </section>

        <!-- SECÇÃO 3: LOADING -->
        <section id="loading-section">
            <div class="spinner"></div>
            <p>A processar imagem...</p>
            <p style="font-size: 0.875rem; color: var(--text-tertiary);">Isto pode demorar alguns segundos</p>
        </section>

        <!-- SECÇÃO 4: RESULTADO -->
        <section id="result-section">
            <h2 class="text-center" style="font-size: 2rem; margin-bottom: 1rem;">Resultado</h2>
            
            <!-- Imagens lado a lado -->
            <div class="comparison">
                <div class="image-box">
                    <h3>Original</h3>
                    <div class="image-wrapper">
                        <img id="result-original" alt="Imagem original">
                    </div>
                </div>
                <div class="image-box">
                    <h3>Editada</h3>
                    <div class="image-wrapper">
                        <img id="result-edited" alt="Imagem editada">
                    </div>
                </div>
            </div>

            <!-- NOVO: Painel de formatos para redes sociais -->
            <div class="format-panel">
                <div class="format-header">
                    <h3 class="format-title">
                        <span>📱</span>
                        <span>Optimizar para Redes Sociais</span>
                    </h3>
                    <p class="format-description">
                        Adapta automaticamente a tua imagem editada para o formato ideal
                    </p>
                </div>
                
                <div class="format-grid">
                    <!-- Instagram Post -->
                    <button 
                        class="liquid-button" 
                        data-format="instagram-post"
                        data-ratio="4:5"
                        data-width="1080"
                        data-height="1350"
                        aria-label="Optimizar para Instagram Post, formato 4:5"
                    >
                        <div class="format-icon">📷</div>
                        <div class="format-info">
                            <div class="format-platform">Instagram</div>
                            <div class="format-type">Post</div>
                            <div class="format-ratio">4:5</div>
                            <div class="format-dimensions">1080x1350</div>
                        </div>
                    </button>

                    <!-- Instagram Reel -->
                    <button 
                        class="liquid-button" 
                        data-format="instagram-reel"
                        data-ratio="9:16"
                        data-width="1080"
                        data-height="1920"
                        aria-label="Optimizar para Instagram Reel, formato 9:16"
                    >
                        <div class="format-icon">📹</div>
                        <div class="format-info">
                            <div class="format-platform">Instagram</div>
                            <div class="format-type">Reel</div>
                            <div class="format-ratio">9:16</div>
                            <div class="format-dimensions">1080x1920</div>
                        </div>
                    </button>

                    <!-- Instagram Story -->
                    <button 
                        class="liquid-button" 
                        data-format="instagram-story"
                        data-ratio="9:16"
                        data-width="1080"
                        data-height="1920"
                        aria-label="Optimizar para Instagram Story, formato 9:16"
                    >
                        <div class="format-icon">📖</div>
                        <div class="format-info">
                            <div class="format-platform">Instagram</div>
                            <div class="format-type">Story</div>
                            <div class="format-ratio">9:16</div>
                            <div class="format-dimensions">1080x1920</div>
                        </div>
                    </button>

                    <!-- TikTok -->
                    <button 
                        class="liquid-button" 
                        data-format="tiktok"
                        data-ratio="9:16"
                        data-width="1080"
                        data-height="1920"
                        aria-label="Optimizar para TikTok, formato 9:16"
                    >
                        <div class="format-icon">🎵</div>
                        <div class="format-info">
                            <div class="format-platform">TikTok</div>
                            <div class="format-type">Video</div>
                            <div class="format-ratio">9:16</div>
                            <div class="format-dimensions">1080x1920</div>
                        </div>
                    </button>
                </div>

                <!-- Feedback visual -->
                <div class="format-feedback" id="format-feedback" aria-live="polite"></div>
            </div>

            <!-- Botões de ação -->
            <div class="download-actions">
                <button class="btn btn-success" id="btn-download">
                    <span>💾</span>
                    <span id="download-text">Download da Imagem Editada</span>
                </button>
                <button class="btn btn-secondary" id="btn-new">
                    <span>🔄</span>
                    <span>Nova Foto</span>
                </button>
            </div>
        </section>

        <!-- SECÇÃO 5: ERRO -->
        <section id="error-section">
            <div class="error-box">
                <div class="error-icon">⚠️</div>
                <p id="error-text"></p>
                <button class="btn btn-primary" id="btn-retry">Tentar Novamente</button>
            </div>
        </section>
    </div>

    <!-- SVG Filter for Liquid Glass Effect -->
    <svg style="position: absolute; width: 0; height: 0;">
        <defs>
            <filter
                id="liquid-glass-filter"
                x="0%"
                y="0%"
                width="100%"
                height="100%"
                colorInterpolationFilters="sRGB"
            >
                <feTurbulence
                    type="fractalNoise"
                    baseFrequency="0.05 0.05"
                    numOctaves="1"
                    seed="1"
                    result="turbulence"
                />
                <feGaussianBlur in="turbulence" stdDeviation="2" result="blurredNoise" />
                <feDisplacementMap
                    in="SourceGraphic"
                    in2="blurredNoise"
                    scale="70"
                    xChannelSelector="R"
                    yChannelSelector="B"
                    result="displaced"
                />
                <feGaussianBlur in="displaced" stdDeviation="4" result="finalBlur" />
                <feComposite in="finalBlur" in2="finalBlur" operator="over" />
            </filter>
        </defs>
    </svg>

    <script>
        // ==================== CONFIGURAÇÃO ====================
        const CONFIG = {
            webhookUrl: 'https://olancador.pt/webhook/fotografo',
            maxFileSize: 10 * 1024 * 1024, // 10MB
            acceptedFormats: ['image/jpeg', 'image/png', 'image/webp'],
            acceptedMimeTypes: {
                'image/jpeg': [0xFF, 0xD8, 0xFF],
                'image/png': [0x89, 0x50, 0x4E, 0x47],
                'image/webp': [0x52, 0x49, 0x46, 0x46]
            },
            requestTimeout: 120000, // 120 segundos
            useFormData: true
        };

        // ==================== ESTADO DA APLICAÇÃO ====================
        const AppState = {
            currentFile: null,
            originalImageUrl: null,
            editedImageUrl: null,
            resizedImageUrl: null,
            currentView: 'upload',
            selectedFormat: null
        };

        // ==================== GESTÃO DE UI ====================
        const UI = {
            showSection(sectionName) {
                console.log(`📍 Mudando para secção: ${sectionName}`);
                
                document.querySelectorAll('section').forEach(section => {
                    section.classList.remove('active');
                });
                
                const section = document.getElementById(`${sectionName}-section`);
                if (section) {
                    section.classList.add('active');
                    AppState.currentView = sectionName;
                } else {
                    console.error(`❌ Secção ${sectionName} não encontrada`);
                }
            },

            showError(message) {
                document.getElementById('error-text').textContent = message;
                this.showSection('error');
            },

            resetApp() {
                console.log('🔄 A resetar aplicação');
                
                AppState.currentFile = null;
                if (AppState.originalImageUrl) {
                    URL.revokeObjectURL(AppState.originalImageUrl);
                }
                if (AppState.resizedImageUrl) {
                    URL.revokeObjectURL(AppState.resizedImageUrl);
                }
                AppState.originalImageUrl = null;
                AppState.editedImageUrl = null;
                AppState.resizedImageUrl = null;
                AppState.selectedFormat = null;

                document.getElementById('file-input').value = '';
                
                // Limpar event handlers antes de resetar as imagens
                const images = ['preview-original', 'result-original', 'result-edited'];
                images.forEach(id => {
                    const img = document.getElementById(id);
                    if (img) {
                        img.onload = null;
                        img.onerror = null;
                        img.removeAttribute('src');
                    }
                });

                // Reset format buttons
                document.querySelectorAll('.liquid-button').forEach(btn => {
                    btn.classList.remove('selected');
                });

                // Reset download button text
                document.getElementById('download-text').textContent = 'Download da Imagem Editada';

                this.showSection('upload');
            }
        };

        // ==================== GESTÃO DE FICHEIROS ====================
        const FileHandler = {
            validate(file) {
                if (!file) {
                    return { valid: false, error: 'Nenhum ficheiro selecionado.' };
                }

                if (file.size > CONFIG.maxFileSize) {
                    const maxMB = CONFIG.maxFileSize / 1024 / 1024;
                    return { 
                        valid: false, 
                        error: `Ficheiro muito grande. Máximo: ${maxMB}MB` 
                    };
                }

                if (!CONFIG.acceptedFormats.includes(file.type)) {
                    return { 
                        valid: false, 
                        error: 'Formato não suportado. Use JPG, PNG ou WEBP.' 
                    };
                }

                return { valid: true };
            },

            async validateRealMimeType(file) {
                try {
                    const buffer = await file.slice(0, 4).arrayBuffer();
                    const bytes = new Uint8Array(buffer);

                    for (const [mimeType, signature] of Object.entries(CONFIG.acceptedMimeTypes)) {
                        if (signature.every((byte, i) => bytes[i] === byte)) {
                            return mimeType;
                        }
                    }

                    return null;
                } catch (error) {
                    console.error('❌ Erro ao validar MIME type:', error);
                    return file.type;
                }
            },

            async toBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },

            createPreview(file) {
                const url = URL.createObjectURL(file);
                const img = document.getElementById('preview-original');
                
                img.onload = null;
                img.onerror = null;
                
                img.onload = () => {
                    console.log('✅ Preview criado com sucesso');
                };
                
                img.onerror = () => {
                    UI.showError('Erro ao carregar preview da imagem.');
                };

                img.src = url;
                AppState.originalImageUrl = url;
            }
        };

        // ==================== IMAGE RESIZER ====================
        const ImageResizer = {
            async resizeImage(imageUrl, targetWidth, targetHeight) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    img.onload = () => {
                        try {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            canvas.width = targetWidth;
                            canvas.height = targetHeight;
                            
                            // Calculate scaling to cover the entire canvas (object-fit: cover)
                            const scale = Math.max(
                                targetWidth / img.width,
                                targetHeight / img.height
                            );
                            
                            const scaledWidth = img.width * scale;
                            const scaledHeight = img.height * scale;
                            
                            // Center the image
                            const x = (targetWidth - scaledWidth) / 2;
                            const y = (targetHeight - scaledHeight) / 2;
                            
                            // Draw image
                            ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
                            
                            // Convert to blob
                            canvas.toBlob((blob) => {
                                if (blob) {
                                    const url = URL.createObjectURL(blob);
                                    resolve(url);
                                } else {
                                    reject(new Error('Falha ao criar blob'));
                                }
                            }, 'image/jpeg', 0.95);
                            
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    img.onerror = () => {
                        reject(new Error('Falha ao carregar imagem'));
                    };
                    
                    img.src = imageUrl;
                });
            },

            updateSelectedButton(button) {
                // Remove selection from all buttons
                document.querySelectorAll('.liquid-button').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                // Add selection to clicked button
                button.classList.add('selected');
            },

            showFeedback(formatName, ratio) {
                const feedback = document.getElementById('format-feedback');
                feedback.textContent = `✓ Formato aplicado: ${formatName} (${ratio})`;
                feedback.classList.add('show');
                
                setTimeout(() => {
                    feedback.classList.remove('show');
                }, 3000);
            },

            updateDownloadButton(formatName, ratio) {
                const downloadText = document.getElementById('download-text');
                if (formatName) {
                    downloadText.textContent = `Download (${formatName} ${ratio})`;
                } else {
                    downloadText.textContent = 'Download da Imagem Editada';
                }
            }
        };

        // ==================== API / WEBHOOK ====================
        const API = {
            async sendToWebhook(file) {
                try {
                    console.log('📤 A enviar para webhook:', CONFIG.webhookUrl);
                    console.log('📁 Ficheiro:', file.name, '|', (file.size / 1024).toFixed(2), 'KB');
                    
                    let response;
                    
                    if (CONFIG.useFormData) {
                        console.log('📦 Usando FormData...');
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('filename', file.name);
                        formData.append('mimeType', file.type);

                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), CONFIG.requestTimeout);

                        response = await fetch(CONFIG.webhookUrl, {
                            method: 'POST',
                            body: formData,
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);
                        
                    } else {
                        console.log('📦 Usando JSON/base64...');
                        const base64 = await FileHandler.toBase64(file);
                        const base64Clean = base64.split(',')[1];
                        
                        const payload = {
                            image: base64Clean,
                            filename: file.name,
                            mimeType: file.type,
                            size: file.size
                        };

                        console.log('📏 Tamanho da payload:', (JSON.stringify(payload).length / 1024).toFixed(2), 'KB');

                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), CONFIG.requestTimeout);

                        response = await fetch(CONFIG.webhookUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload),
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);
                    }

                    console.log('📡 Status da resposta:', response.status, response.statusText);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('❌ Erro do servidor:', errorText);
                        throw new Error(`Erro ${response.status}: ${response.statusText}`);
                    }

                    const contentType = response.headers.get('content-type');
                    console.log('📄 Content-Type:', contentType);

                    let result;
                    if (contentType && contentType.includes('application/json')) {
                        result = await response.json();
                    } else {
                        const text = await response.text();
                        console.log('📝 Resposta (texto):', text.substring(0, 200));
                        result = { editedImage: text };
                    }

                    console.log('✅ Resposta do webhook:', result);

                    if (!result.editedImage && !result.image) {
                        throw new Error('Resposta inválida do servidor.');
                    }

                    return {
                        success: true,
                        editedImage: result.editedImage || result.image,
                        originalImage: result.originalImage || AppState.originalImageUrl
                    };

                } catch (error) {
                    console.error('❌ Erro na comunicação com webhook:', error);
                    
                    if (error.name === 'AbortError') {
                        throw new Error('Tempo limite excedido. A imagem pode ser muito grande.');
                    }

                    if (error.message.includes('Failed to fetch')) {
                        throw new Error('Erro de conexão. Verifique:\\n• Webhook está ativo?\\n• CORS configurado?\\n• Internet funcional?');
                    }

                    throw error;
                }
            }
        };

        // ==================== EVENT HANDLERS ====================
        const Events = {
            init() {
                console.log('🚀 A inicializar eventos...');
                this.initDropZone();
                this.initFileInput();
                this.initButtons();
                this.initFormatButtons();
            },

            initDropZone() {
                const dropZone = document.getElementById('drop-zone');

                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('drag-over');
                });

                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('drag-over');
                });

                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');

                    const file = e.dataTransfer.files[0];
                    this.handleFileSelect(file);
                });

                dropZone.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'BUTTON') {
                        document.getElementById('file-input').click();
                    }
                });
            },

            initFileInput() {
                document.getElementById('file-input').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    this.handleFileSelect(file);
                });
            },

            async handleFileSelect(file) {
                console.log('📁 Ficheiro selecionado:', file?.name);
                
                const validation = FileHandler.validate(file);
                if (!validation.valid) {
                    UI.showError(validation.error);
                    return;
                }

                const realMimeType = await FileHandler.validateRealMimeType(file);
                if (!realMimeType || !CONFIG.acceptedFormats.includes(realMimeType)) {
                    UI.showError('Tipo de ficheiro inválido. Use apenas imagens JPG, PNG ou WEBP.');
                    return;
                }

                AppState.currentFile = file;
                FileHandler.createPreview(file);
                UI.showSection('preview');
            },

            initButtons() {
                document.getElementById('btn-send').addEventListener('click', () => {
                    this.handleSend();
                });

                document.getElementById('btn-cancel').addEventListener('click', () => {
                    UI.resetApp();
                });

                document.getElementById('btn-download').addEventListener('click', () => {
                    this.handleDownload();
                });

                document.getElementById('btn-new').addEventListener('click', () => {
                    UI.resetApp();
                });

                document.getElementById('btn-retry').addEventListener('click', () => {
                    UI.resetApp();
                });
            },

            initFormatButtons() {
                document.querySelectorAll('.liquid-button').forEach(button => {
                    button.addEventListener('click', async () => {
                        if (button.classList.contains('loading')) return;
                        
                        const format = button.dataset.format;
                        const ratio = button.dataset.ratio;
                        const width = parseInt(button.dataset.width);
                        const height = parseInt(button.dataset.height);
                        const formatName = button.querySelector('.format-platform').textContent + ' ' + 
                                          button.querySelector('.format-type').textContent;
                        
                        try {
                            button.classList.add('loading');
                            
                            console.log(`📐 A redimensionar para ${formatName} (${width}x${height})...`);
                            
                            // Liberar URL anterior se existir
                            if (AppState.resizedImageUrl) {
                                URL.revokeObjectURL(AppState.resizedImageUrl);
                            }
                            
                            // Redimensionar imagem
                            const resizedUrl = await ImageResizer.resizeImage(
                                AppState.editedImageUrl,
                                width,
                                height
                            );
                            
                            AppState.resizedImageUrl = resizedUrl;
                            AppState.selectedFormat = { format, ratio, width, height, name: formatName };
                            
                            // Update UI
                            ImageResizer.updateSelectedButton(button);
                            ImageResizer.showFeedback(formatName, ratio);
                            ImageResizer.updateDownloadButton(formatName, ratio);
                            
                            console.log(`✅ Imagem redimensionada para ${formatName}`);
                            
                        } catch (error) {
                            console.error('❌ Erro ao redimensionar:', error);
                            UI.showError('Erro ao redimensionar a imagem. Tente novamente.');
                        } finally {
                            button.classList.remove('loading');
                        }
                    });
                });
            },

            async handleSend() {
                try {
                    console.log('🚀 A enviar imagem para processamento...');
                    
                    UI.showSection('loading');

                    const result = await API.sendToWebhook(AppState.currentFile);

                    AppState.editedImageUrl = result.editedImage;

                    document.getElementById('result-original').src = AppState.originalImageUrl;
                    document.getElementById('result-edited').src = result.editedImage;

                    console.log('✅ Imagem processada com sucesso');
                    UI.showSection('result');

                } catch (error) {
                    console.error('❌ Erro ao processar imagem:', error);
                    UI.showError(error.message || 'Erro ao processar a imagem. Tente novamente.');
                }
            },

            handleDownload() {
                // Se há uma imagem redimensionada, usar essa; caso contrário usar a editada original
                const imageUrl = AppState.resizedImageUrl || AppState.editedImageUrl;
                
                if (!imageUrl) {
                    UI.showError('Nenhuma imagem para download.');
                    return;
                }

                console.log('💾 A fazer download da imagem...');

                const link = document.createElement('a');
                link.href = imageUrl;
                
                const timestamp = new Date().getTime();
                const originalName = AppState.currentFile?.name || 'imagem';
                const baseName = originalName.split('.')[0];
                const extension = originalName.split('.').pop();
                
                // Nome do ficheiro com formato se aplicável
                if (AppState.selectedFormat) {
                    const formatSlug = AppState.selectedFormat.format;
                    link.download = `${baseName}_${formatSlug}_${timestamp}.${extension}`;
                } else {
                    link.download = `${baseName}_editada_${timestamp}.${extension}`;
                }
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('✅ Download iniciado');
            }
        };

        // ==================== INICIALIZAÇÃO ====================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('═══════════════════════════════════════');
            console.log('  O fotografo - Editor de Fotografias  ');
            console.log('═══════════════════════════════════════');
            console.log('🌐 Webhook URL:', CONFIG.webhookUrl);
            console.log('📦 Modo de envio:', CONFIG.useFormData ? 'FormData' : 'JSON/base64');
            console.log('📏 Tamanho máximo:', (CONFIG.maxFileSize / 1024 / 1024), 'MB');
            console.log('⏱️ Timeout:', (CONFIG.requestTimeout / 1000), 'segundos');
            console.log('📱 Formatos disponíveis: Instagram Post, Reel, Story, TikTok');
            console.log('═══════════════════════════════════════');
            Events.init();
        });
    </script>
</body>
</html>